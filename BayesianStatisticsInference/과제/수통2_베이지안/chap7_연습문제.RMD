---
title: "수리통계학 Ⅱ - chap 7 실습"
author: "이하늘, 가천대학교 응용통계학과 202340339"
date: 2023-04-15(SAT)
output:
  html_document:
    code_folding: show
    fig_caption: yes
    fig_height: 10
    fig_width: 10
    highlight: haddock
    self_contained: yes
    theme: cosmo
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<style type="text/css">
  body, td {
     font-size: 16px;
     font-family: 맑은 고딕
  }
  code.r{
    font-size: 16px;
    font-weight: bold;
    font-family: 맑은 고딕
  }
  pre {
    font-size: 14px
    font-family: 맑은 고딕
  }
  h1,h2,h3,h4,h5,h6{
    font-family: 맑은 고딕;
  }
  h1{
    font-size: 22pt;
  }
  h2{
    font-size: 20pt;
  }
  h3{
    font-size: 18pt;
  }
</style>

<br>

# 1. \(X \sim N(\theta,\sigma^2 = 10)\), 사전정보\(\theta \sim N(\mu_0 = 100, \sigma_0^2 = 25)\), 만약 모집단에서 10개의 표본이 관측되었고 이때의 값이 \(\bar{x} = 100\)일 경우 \(\theta\)의 사후분포와 베이즈 추정치를 구하라.


\[
c = \frac{1}{\sigma^2/n}, c_0 = \frac{1}{\sigma_0^2}\\
\mu_\pi = \frac{c}{c + c_0}\bar{x} + \frac{c_0}{c + c_0}\mu_0\\
\sigma_\pi^2 = \frac{1}{(c + c_0)}
\]


여기서 n은 표본의 수, \(\bar{x}\)는 표본평균


```{r}
mu_0 <- 100
sigma_0 <- sqrt(25)
sigma <- sqrt(10)
n <- 10
x_bar <- 110


c <- 1/(sigma^2/n)
c
c_0 <- 1/(sigma_0^2)
c_0
sigma_pi <- 1/(c + c_0)
mu_pi <- (c/(c+c_0)*x_bar) + (c_0/(c+c_0)*mu_0)
```

\[
\theta|\bar{x} \sim N(\mu_\pi = 109.6154, \sigma_\pi^2 =0.9615385) \\
\theta의 베이즈 추정치 = 109.6154
\]

# 2. 분산이 \(\sigma^2 = 21\)인 정규분포를 따르는 20개의 자료로부터 \(\bar{x} = 150\)이 주어졌다.

## 2-(1). X의 평균 \(\theta\)의 사전분포로 평균 150, 분산 21인 정규분포를 가정할 때 \(\theta\)의 사후분포를 구하고 \(\theta\)의 95% 최대사후구간을 구하라.

\[
사전분포 = \theta \sim N(\mu_0 = 150, \sigma_0^2 = 21)\\
X \sim N(\theta, \sigma^2 = 21) \\
95 최대사후구간 = [\mu_\pi ± 1.96*\sigma_\pi^2]
\]



```{r}
mu0 = 150; sig0 = sqrt(21); n = 20; xbar = 150; s = sqrt(21/n)

#posterior
c= n/s^2 ; c0=1/sig0^2; w = c/(c+c0)
mu.post = w * xbar + (1-w)* mu0; sig.post = sqrt( 1/(c+c0) )

# 95% 신뢰구간
lower_bound <- mu.post - 1.96*sig.post
upper_bound <- mu.post + 1.96*sig.post

c(lower_bound, upper_bound)

```

\[
\theta|\bar{x} \sim N(\mu_\pi = 150, \sigma_\pi^2 = 0.2288429) \\
\theta의 HPD = (149.5515, 150.4485)
\]


## 2-(2). 사전정보가 없을 경우

\[
\theta|\bar{x} \sim N(\bar{x},\sigma^2/n) \\
\theta|\bar{x} \sim N(150,21^2/20)
\]

```{r}

mu.post = 150; sig.post = sqrt(21/20)

# 95% 신뢰구간
lower_bound <- mu.post - 1.96*sig.post
upper_bound <- mu.post + 1.96*sig.post

c(lower_bound, upper_bound)
```
\[
\theta|\bar{x} \sim N(150,1.024695) \\
\theta의 HPD = (147.9916, 152.0084)
\]

## 2-(3). 사후밀도함수 겹쳐그리기

```{r}
# 필요한 라이브러리 불러오기
library(ggplot2)
library(coda)

# 사전 정보가 있는 경우
mu0 = 150; sig0 = sqrt(21); n = 20; xbar = 150; s = sqrt(21/n)
c= n/s^2 ; c0=1/sig0^2; w = c/(c+c0)
mu.post1 = w * xbar + (1-w)* mu0; sig.post1 = sqrt( 1/(c+c0) ) 

# 사전 정보가 없는 경우
mu.post2 = 150; sig.post2 = sqrt(21/20)

# 사후 분포 그리기
x <- seq(140, 160, length.out = 1000)
density1 <- dnorm(x, mu.post1, sig.post1)
density2 <- dnorm(x, mu.post2, sig.post2)

data <- data.frame(x = x, density1 = density1, density2 = density2)

ggplot(data, aes(x = x)) +
  geom_line(aes(y = density1), color = "blue") +
  geom_line(aes(y = density2), color = "red") +
  labs(x = "Theta", y = "Density", 
       title = "Posterior Densities",
       subtitle = "Blue: with prior knowledge, Red: without prior knowledge") +
  theme_minimal()
```


## 2-(4). 20개 + 10개, 10개의 미래 관측치의 평균에 대한 예측 분포.

```{r}
# 필요한 라이브러리 불러오기
library(ggplot2)

# 사후분포
mu0 = 150; sig0 = sqrt(21); n = 20; xbar = 150; s = sqrt(21/n)
c= n/s^2 ; c0=1/sig0^2; w = c/(c+c0)
mu.post = w * xbar + (1-w)* mu0; sig.post = sqrt( 1/(c+c0) ) 

# 예측분포
n_new = 10
s_new = s / sqrt(n_new) # 새로운 관측치들의 평균에 대한 표준편차
mu.new = mu.post; sig.new = sqrt( sig.post^2 + s_new^2 )

# 예측 분포 그리기
xnew=seq(mu.new - 5* sig.new , mu.new + 5* sig.new, length=100)
plot(xnew, dnorm(xnew, mu.new, sig.new),type="l", main="Predictive density of X_bar_new")
```

\[
X_{new} \sim N(150,0.3966977) \\
\]

## 2-(5). 위의 10개의 미래 관측치의 평균이 (150, 153)의 구간에 속할 확률은?

```{r}
prob = pnorm(153, mu.new, sig.new) - pnorm(150, mu.new, sig.new)
prob
```


# 3. 증명

\[
\pi(\theta) = 1, \quad \pi(\sigma^2) = \frac{1}{\sigma^2}, \quad \pi(\theta, \sigma^2) = \pi(\theta) \cdot \pi(\sigma^2)
\]

\[
L(\theta, \sigma^2|x_1, ..., x_n) = (2\pi\sigma^2)^{-n/2} \cdot \exp\left(-\frac{\sum_{i=1}^{n}(x_i - \theta)^2}{2\sigma^2}\right)
\]

\[
\pi(\theta, \sigma^2|x_1, ..., x_n) \propto (2\pi\sigma^2)^{-n/2} \cdot \exp\left(-\frac{\sum_{i=1}^{n}(x_i - \theta)^2}{2\sigma^2}\right) \cdot \pi(\theta) \cdot \pi(\sigma^2)
\]


\[
\theta의 사후분포\\
\pi(\theta|x_1, ..., x_n, \sigma^2) \sim N(\bar{x},\sigma^2/n)
\]


\[
\sigma^2의 사후분포\\
\pi(\sigma^2|x_1, ..., x_n) \sim IG\left(\frac{n-1}{2}, \frac{S}{2}\right)
\]




# 4. 이화여대 통계학과생들의 A 과목 기말고사 성적 X가 미지의 평균 \(\theta\)와 분산 \(\sigma^2\)을 갖는 정규분포, 20명의 학생

## 4-(1).\(\sigma^2\)이 주어졌을 때 \(\theta\)의 조건부 사후분포


\[
\pi(\theta|x_1,...,x_{20},\sigma^2) \sim N(\bar{x},\sigma^2/n)
\]

```{r}
x <-  c(95, 77, 63, 34, 87, 89, 92, 85, 98, 52, 48, 72, 89, 63, 67, 78, 92, 85, 78, 99)
x_bar <- mean(x)
```

\[
\pi(\theta|x_1,...,x_{20},\sigma^2) \sim N(77.15,\sigma^2/20)
\]

## 4-(2).\(\theta\)의 사후분포, 베이즈 추정치

\[
\pi(\theta|x_1,...,x_{20}) \sim t_{n-1}(\bar{x},s^2/n)
\]


```{r}
# 데이터 입력
scores <- c(95, 77, 63, 34, 87, 89, 92, 85, 98, 52, 48, 72, 89, 63, 67, 78, 92, 85, 78, 99)

# 표본 개수
n <- length(scores)

# 표본 평균 (세타의 베이지 추정치)
bayes_estimate_theta <- mean(scores)

# 표본 분산 
s2 <- sd(scores)

# 세타의 사후분포의 분산
post_var_theta <- (s2)^2 / n
bayes_estimate_theta;post_var_theta  #[1] 77.15 [1] 15.91724
```

\[
\pi(\theta|x_1,...,x_{20}) \sim N(77.15, 0.8921109)
\]

## 4-(3).\(\theta\)의 고전적 추정치와 베이즈 추정치 비교

\(\theta\)의 고전적 추정치는 표본평균, 불편추정량
\[
E[\bar{x}] = \theta \\
\]

\(\theta\)의   고전적 추정치와 베이지 추정치는 동일

```{r}
bayes_estimate_theta #77.15
```

## 4-(4).\(\sigma^2\)의 사후분포, 고전적 추정치와 베이즈 추정치 비교

\[
\pi(\sigma^2|x_1,...,x_{20}) \sim IG(\frac{n-1}{2},\frac{S}{2}) \\
S = s^2*(n-1)
\]

```{r}
library(MCMCpack)
n <- length(scores)
x_bar <- mean(scores)
s <- sd(scores)
a <- (n-1)/2
S <- (s^2)*(n-1)
b <- S / 2
sigsq.grid=seq(0,1000,length=1000)


post.sigsq = dinvgamma(sigsq.grid,a, scale=b)
plot(sigsq.grid,post.sigsq,type="l",xlab="sigma_sq",ylab="marginal posterior")
a;b

#베이즈 추정치
b/(a-1)
```

\[
\pi(\sigma^2|x_1,...,x_{20}) \sim IG(9.5,3024.275)\\
고전적 \sigma^2 = 318.3447\\
베이즈 \sigma^2 = 355.7971
\]


# 5. X1,...Xn이 독립적으로 \(\theta\)와 분산 \(1\)을 갖는 정규분포, n = 20, \(\bar{x}=0.33\)

## 5-(1).\(\theta\)의 사후분포 유도, 사후밀도함수 그림


```{r}
library(msm)
n = 20
x_bar = 0.33

# 사후분포를 그래프로 나타냅니다.
theta = seq(0, 1.5, length.out = 1000)
posterior = dtnorm(theta, mean = x_bar, sd = sqrt(1/n), lower = 0)
plot(theta, posterior, type = "l", xlab = "Theta", ylab = "Density", main = "Posterior distribution")


sqrt(1/n)^2
```

\[
\pi(\theta|x_1,...,x_{20}) \sim N(0.33, 0.05)
\]


## 5-(2).\(\theta\)의 95% 최대사후구간을 구하라.

```{r}
HPDgrid <- function(prob,level=0.95){
  prob.sort=sort(prob,decreasing = T)
  M=min(which(cumsum(prob.sort)>=level))
  height=prob.sort[M]
  HPD.index=which(prob>=height)
  HPD.level=sum(prob[HPD.index])
  res=list(index=HPD.index, level=HPD.level)
  return(res)
}

prob=posterior/sum(posterior)
HPD <- HPDgrid(prob,0.95)
HPD.grid <- c(min(theta[HPD$index]),max(theta[HPD$index]))
HPD.grid

plot(theta,posterior,type = 'l')
abline(v=HPD.grid)
```

\[
\theta의 HPD = (0.0000000 0.7057057)
\]





<br>
  
  
  
# References {-}s
  
[R tutorial](https://cran.r-project.org/doc/manuals/r-release/R-intro.html)


--------------------------------------------------------------------------------------------------
  
  ⓒ Statistical Methods, Gachon University

--------------------------------------------------------------------------------------------------
  

